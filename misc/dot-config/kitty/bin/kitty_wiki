#!/usr/bin/env zsh
#
setopt extendedglob

wiki_dir=$HOME/wiki

unset FZF_DEFAULT_OPTS

gawk 'FNR < 8 && /^title:\s+/ {$1=""; idx=split(FILENAME, parts, "/"); sub(/\.md/, "", parts[idx]); print parts[idx]"\t",$0; nextfile}' $wiki_dir/*.md(om) | \
fzf \
  --prompt 'WIKI > ' \
  -q "$*" \
  --no-mouse \
  --preview "bat -pp --color=always --theme=Coldark-Dark $wiki_dir/{1}.md" \
  --bind "ctrl-c:execute(cat $wiki_dir/{1}.md|pbcopy && kitten notify Zwiki '已复制「{1}.md」')" \
  --bind "enter:execute(nvim $wiki_dir/{1}.md)" \
  --bind "tab:execute(nvim +ZwikiNew +'silent norm \"+P')" \
  --bind "esc:clear-query" \
  --header "[ENTER] edit | [TAB] new | [ESC] clear | [C-C] copy | [C-D] exit"
