# vim: fdm=marker

# settings {{{
@allow-unmapped-commands
# otherwise backspace would not work
@macos-toggle-fn
@forward-modifiers Shift Control
@options verbose
@enforce-lowercase-commands

# device matchers
KeyboardLogitechWave = /Logitech USB Receiver/i
KeyboardThinkpadX1C  = /AT Translated Set 2 keyboard/i
ElecomDeftPro = /DEFT Pro Trackball/i

# sequence definitions
Combo  = $0{!150ms} !250ms $1{!150ms}
Double = $0 !200ms $0
Press  = $0{!200ms}
Nested = $0 !$0

# alias
Win        = Meta
Cmd        = Meta
Ctrl       = Control
CmdL       = MetaLeft
CmdR       = MetaRight
AltL       = AltLeft
AltR       = AltRight
CtrL       = ControlLeft
CtrR       = ControlRight
ShiftL     = ShiftLeft
ShiftR     = ShiftRight
Hyper      = (Control Meta Alt Shift)
Modifier   = Control | Meta | Shift | Alt

ViMode       = Virtual
AltLayout    = Virtual
ScreenLayout = Virtual
# }}}

# {{{ functions
[ system = 'MacOS' ]
  message = $(osascript -e 'display notification "$0" with title "KeyMapper"')
  km      = $(osascript -e 'tell application "Keyboard Maestro Engine" to do script "$0"') ^
  app     = $(open -a "$0") ^
  anybar  = $(osascript -e 'tell application "AnyBar" to set image name to "$0"')

[ system = 'Linux' ]
  app     = $("$0") ^
# }}}

# {{{ STAGE 1: device specific basic key overrides
# Right option to Control for logitech wave keys
[ device = KeyboardLogitechWave ]
  AltR >> CtrR

[device = KeyboardThinkpadX1C ]
  AltR >> CmdR
  AltL >> CmdL
  CmdL >> AltL
  CmdR >> Ctrl

[default]
  # CapsLock to esc when tapped
  # Prevent CapsLock from being used
  Press[CapsLock] >> Escape
  CapsLock >>
  CapsLock{Any} >> !CapsLock Hyper{Any}

[stage]
# }}}

# {{{ STAGE 2: general overrides
[default]
  Meta{K}         >> choose_tab
  Hyper{H}        >> ArrowLeft
  Hyper{J}        >> ArrowDown
  Hyper{K}        >> ArrowUp
  Hyper{L}        >> ArrowRight
  Hyper{U}        >> prev_tab
  Hyper{O}        >> next_tab
  Hyper{Y}        >> PageUp
  Hyper{N}        >> PageDown
  Hyper{PageUp}   >> AudioVolumeUp
  Hyper{PageDown} >> AudioVolumeDown
  Cmd{X}      >> cut
  Cmd{C}      >> copy
  Cmd{F}      >> find
  Cmd{Q}      >> close
  Double[Cmd] >> toggle

[ class != "kitty" ]
  # kitty binds paste
  Cmd{V} >> paste
  # this bind to wiki
  Cmd{Z} >> undo

[device != ElecomDeftPro]
  ButtonForward   >> screenshot
  Ctrl{ButtonForward} >> screenshot_alt

[device = ElecomDeftPro ]
  # function 1
  0x0115 >> screenshot_alt
  # function 2
  0x0116 >> close_tab
  # function 3
  0x0117 >> screenshot

# {{{ context dependent bindings
#
[ modifier = "ScreenLayout" ]
  H >> $(xdotool getactivewindow windowsize 50% 100% windowmove 0 y) ^ ScreenLayout
  L >> $(xdotool getactivewindow windowsize 50% 100% windowmove 50% y) ^ ScreenLayout
  F >> $(xdotool getactivewindow windowsize 100% 100% windowmove 0 0) ^ ScreenLayout
  K >> $(xdotool getactivewindow windowsize 100% 50% windowmove 0 0) ^ ScreenLayout
  J >> $(xdotool getactivewindow windowsize 100% 50% windowmove 100% 50%) ^ ScreenLayout
  Any >> ScreenLayout

[ system = 'Linux' ]
  Cmd{D}        >> $(xdotool search --class kitty windowactivate key "super+d") ^
  Cmd{M}        >> $(xdotool search --class kitty windowactivate key "super+m") ^
  Cmd{Z}        >> $(xdotool search --class kitty windowactivate key "super+z") ^
  Hyper{Enter}  >> $(xdotool search --class kitty windowactivate key "ctrl+alt+shift+super+Return") ^
  Hyper{M}      >> ScreenLayout
  Hyper{V}      >> $(gpaste-client ui) ^

[ system = 'Linux' class = /vivaldi/i ]
  Cmd{L} >> Ctrl{L}
  Cmd{T} >> Ctrl{T}
  Cmd{W} >> close_tab
  Cmd{R} >> F2
  Cmd{8} >> (AltL Shift){L}
  Cmd{K} >> Ctrl{K}

[system = "MacOS"]
  # tap left shift to delete world left
  ShiftLeft >> Alt{Backspace}

# }}}

# }}}

# {{{ abstract commands
[default]
  prev_tab     >> F11
  next_tab     >> F12
  close_tab    >> Ctrl{W}
  paste        >> Paste
  copy         >> Copy 20ms ArrowRight
  cut          >> Cut
  find         >> Ctrl{F}
  undo         >> Undo
  back_word    >> Alt{ArrowLeft}
  forward_word >> Alt{ArrowRight}
  go_to_end    >>
  go_to_start  >>
  go_to_top    >>
  go_to_bottom >>
  screenshot     >> $(gnome-screenshot -a -c) ^
  screenshot_alt >> $(gnome-screenshot -i) ^
  alt_layout   >> anybar["red"] ^ anybar["hollow"]
  toggle       >> Cmd{Tab}

[system='MacOS']
  copy         >> Cmd{C} 20ms ArrowRight
  cut          >> Cmd{X}
  paste        >> Cmd{V}
  find         >> Cmd{F}
  undo         >> Cmd{Z}
  close_tab    >> Cmd{W}
  back_word    >> Alt{ArrowLeft}
  forward_word >> Alt{ArrowRight}
  go_to_end    >> Cmd{ArrowRight}
  go_to_start  >> Cmd{ArrowLeft}
  go_to_top    >> Cmd{ArrowUp}
  go_to_bottom >> Cmd{ArrowDown}

[system = "Linux" class = /vivaldi/i ]
  prev_tab >> Ctrl{PageUp}
  next_tab >> Ctrl{PageDown}

# }}}
